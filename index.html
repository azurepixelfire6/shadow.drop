<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>ShadowDrop OTA</title>
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%23111111'/><path d='M50 30c-8 0-14 6-14 14s6 14 14 14 14-6 14-14-6-14-14-14zm0 22c-4 0-8-4-8-8s4-8 8-8 8 4 8 8-4 8-8 8z' fill='%23ffffff'/></svg>" />
    <style>
        :root{--bg:#111;--card:#1e1e1e;--accent:#007aff;--text:#fff;--muted:#aaa}
        *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
        body{background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;min-height:100dvh;display:flex;flex-direction:column;align-items:center;padding:20px;line-height:1.5}
        .c{max-width:400px;width:100%;margin:auto}
        .header{text-align:center;margin-bottom:30px}
        .logo{width:80px;height:80px;background:var(--card);border-radius:20px;margin:0 auto 16px;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 12px rgba(0,0,0,.3)}
        .logo svg{width:48px;height:48px;fill:var(--text)}
        h1{font-size:24px;font-weight:600;margin-bottom:4px}
        .sub{font-size:15px;color:var(--muted)}
        .card{background:var(--card);border-radius:18px;padding:20px;margin-bottom:20px;box-shadow:0 4px 12px rgba(0,0,0,.3);text-align:center}
        .drop{border:2px dashed var(--muted);border-radius:14px;padding:40px 20px;cursor:pointer;transition:.2s;position:relative;margin-bottom:20px}
        .drop:hover,.drop.drag{border-color:var(--accent);background:rgba(0,122,255,.05)}
        .drop.drag{background:rgba(0,122,255,.1)}
        .icon{width:48px;height:48px;margin:0 auto 12px;fill:var(--muted)}
        .txt{font-size:16px;color:var(--text);margin-bottom:4px}
        .hint{font-size:13px;color:var(--muted)}
        input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer}
        .btn{background:var(--accent);color:#fff;border:none;border-radius:12px;padding:14px 24px;font-size:17px;font-weight:600;width:100%;cursor:pointer;transition:.2s;margin-top:10px;box-shadow:0 2px 6px rgba(0,122,255,.3)}
        .btn:disabled{background:#444;cursor:not-allowed;box-shadow:none}
        .info{margin-top:16px;font-size:14px;color:var(--muted);word-break:break-all}
        .prog{height:4px;background:#333;border-radius:2px;margin:16px 0;overflow:hidden;display:none}
        .bar{height:100%;background:var(--accent);width:0%;transition:width .3s}
        .res{display:none;margin-top:20px}
        .link{background:#2a2a2a;padding:12px;border-radius:10px;font-size:14px;word-break:break-all;margin:12px 0;color:var(--accent)}
        .copy{background:#333;color:var(--text);border:none;border-radius:8px;padding:8px 16px;font-size:14px;margin-top:8px}
        .install{display:inline-block;background:var(--accent);color:#fff;padding:14px 32px;border-radius:12px;font-size:17px;font-weight:600;text-decoration:none;margin:16px 0;box-shadow:0 2px 6px rgba(0,122,255,.3)}
        .warn{font-size:13px;color:#ff9f0a;margin:16px 0;padding:12px;background:rgba(255,159,10,.1);border-radius:10px;border:1px solid rgba(255,159,10,.3)}
        .footer{margin-top:40px;font-size:12px;color:var(--muted);text-align:center}
        @media(prefers-color-scheme:light){
            :root{--bg:#f2f2f7;--card:#fff;--text:#000;--muted:#666}
            .link{background:#f0f0f0}
        }
    </style>
</head>
<body>
<div class="c">
    <div class="header">
        <div class="logo"><svg viewBox="0 0 100 100"><rect width="100" height="100" rx="20" fill="currentColor" opacity=".1"/><path d="M50 30c-8 0-14 6-14 14s6 14 14 14 14-6 14-14-6-14-14-14zm0 22c-4 0-8-4-8-8s4-8 8-8 8 4 8 8-4 8-8 8z" fill="currentColor"/></svg></div>
        <h1>ShadowDrop OTA</h1>
        <p class="sub">Upload IPA → Instant OTA link (no signup)</p>
    </div>

    <div class="card">
        <div class="drop" id="drop">
            <input type="file" accept=".ipa" id="ipa"/>
            <svg class="icon" viewBox="0 0 24 24"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/></svg>
            <div class="txt">Drop IPA or tap to select</div>
            <div class="hint">Max 500 MB • OTA link generated automatically</div>
        </div>
        <div id="info" class="info" style="display:none;"></div>
        <div class="prog" id="prog"><div class="bar" id="bar"></div></div>
        <button class="btn" id="up" disabled>Upload &amp; Generate OTA</button>
    </div>

    <div class="card res" id="res">
        <h3>OTA Install Ready!</h3>
        <p>Tap the button below on your iPhone/iPad:</p>
        <div class="link" id="otaLink"></div>
        <button class="copy" id="copy">Copy OTA Link</button>
        <a href="#" id="install" class="install" style="display:none;">Install Now</a>

        <div class="warn">
            <strong>Note:</strong> Unsigned IPAs need a signing tool (AltStore, Sideloadly, TrollStore, etc.).
        </div>

        <p style="font-size:13px;color:var(--muted);margin-top:16px;">
            Direct IPA: <span id="direct" style="color:var(--accent);"></span>
        </p>
    </div>

    <div class="footer">
        ShadowDrop OTA • Free & Anonymous • Powered by <a href="https://pages.github.com" target="_blank" style="color:var(--accent);">GitHub Pages</a>
    </div>
</div>

<script>
/* ---------- Helpers ---------- */
const $ = s => document.querySelector(s);
const fmt = b => {if(!b)return'0 B';const k=1024,s=['B','KB','MB','GB'],i=Math.floor(Math.log(b)/Math.log(k));return parseFloat((b/Math.pow(k,i)).toFixed(2))+' '+s[i];};

/* ---------- Drag & Drop ---------- */
const drop = $('#drop'), ipa = $('#ipa'), up = $('#up'), info = $('#info'), prog = $('#prog'), bar = $('#bar');
const res = $('#res'), otaLink = $('#otaLink'), direct = $('#direct'), copy = $('#copy'), install = $('#install');

let file = null, ipaUrl = '', bundle = 'com.unknown.app', appName = '';

['dragenter','dragover','dragleave','drop'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault();e.stopPropagation();}));
['dragenter','dragover'].forEach(ev=>drop.addEventListener(ev,()=>drop.classList.add('drag')));
['dragleave','drop'].forEach(ev=>drop.addEventListener(ev,()=>drop.classList.remove('drag')));

drop.addEventListener('drop',e=>handle(e.dataTransfer.files));
ipa.addEventListener('change',()=>handle(ipa.files));

function handle(files){
    if(!files.length)return;
    const f = files[0];
    if(!f.name.toLowerCase().endsWith('.ipa'))return alert('Select an .ipa file');
    file = f; appName = f.name.replace('.ipa','');
    info.textContent = `${f.name} (${fmt(f.size)})`;
    info.style.display='block';
    up.disabled=false;
}

/* ---------- Upload & OTA ---------- */
up.addEventListener('click', async ()=>{
    if(!file)return;
    up.disabled=true; up.textContent='Uploading…';
    prog.style.display='block'; bar.style.width='0%';

    const fd = new FormData(); fd.append('file',file);

    try{
        // 1. Upload IPA to a free file host that returns direct URL
        //    We use **file.io** (no signup, 2 GB, 14-day link)
        const r = await fetch('https://file.io/?expires=14d', {method:'POST',body:fd});
        const j = await r.json();
        if(!j.success) throw new Error('Upload failed');
        ipaUrl = j.link;                               // direct IPA URL
        direct.textContent = ipaUrl;

        // 2. Prompt for bundle ID (you can replace with auto-extract later)
        const user = prompt('Enter Bundle ID (e.g. com.example.myapp):', bundle);
        if(user) bundle = user;

        // 3. Build manifest.plist as a data-URI (no extra file needed)
        const plist = `<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>items</key>
    <array>
        <dict>
            <key>assets</key>
            <array>
                <dict>
                    <key>kind</key><string>software-package</string>
                    <key>url</key><string>${ipaUrl}</string>
                </dict>
            </array>
            <key>metadata</key>
            <dict>
                <key>bundle-identifier</key><string>${bundle}</string>
                <key>kind</key><string>software</string>
                <key>title</key><string>${appName}</string>
            </dict>
        </dict>
    </array>
</dict>
</plist>`.trim();

        const plistBlob = new Blob([plist],{type:'application/xml'});
        const plistURL = URL.createObjectURL(plistBlob);

        // 4. OTA link
        const ota = `itms-services://?action=download-manifest&url=${encodeURIComponent(plistURL)}`;
        otaLink.textContent = ota;
        install.href = ota;
        install.style.display='inline-block';
        res.style.display='block';
        bar.style.width='100%';
        setTimeout(()=>{prog.style.display='none';},600);

    }catch(e){
        alert('Upload failed – try again or use Diawi/InstallOnAir');
        console.error(e);
    }finally{
        up.textContent='Upload & Generate OTA';
        up.disabled=false;
    }
});

/* ---------- Copy ---------- */
copy.addEventListener('click',()=>{
    navigator.clipboard.writeText(otaLink.textContent);
    copy.textContent='Copied!';
    setTimeout(()=>copy.textContent='Copy OTA Link',2000);
});
</script>
</body>
</html>
